<!DOCTYPE html>
<html>
  <head>
    <title>DJ Page</title>
    <link rel="stylesheet" href="/static/DJ/style.css" />
    <script>
      function addPlaylist() {
        const dialog = document.querySelector("dialog#add_playlist");
        dialog.showModal();
      }

      function getCurrentTimeslotId() {
        const selectedTimeslot = document.querySelector(
          'input[name="timeslot"]:checked'
        );

        if (!selectedTimeslot) {
          alert("Please select a timeslot");
          return;
        }

        if (!selectedTimeslot.id.startsWith("timeslot_")) {
          alert("Error selecting timeslot (malformed timeslot ID)");
          return;
        }

        const timeslotId = selectedTimeslot.id.substring(9);

        return timeslotId;
      }

      function deleteSong(id) {
        const timeslotId = getCurrentTimeslotId();

        if (!timeslotId) {
          return;
        }

        const res = fetch(`/dj/api/playlist/${timeslotId}/${id}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (res.ok) {
              window.location.reload();
            } else {
              throw new Error("Error deleting song");
            }
          })
          .catch((err) => {
            console.error("Error deleting song", err);
            alert("Error deleting song");
          });
      }

      function saveSong(id) {
        const timeslotId = getCurrentTimeslotId();

        if (!timeslotId) {
          return;
        }

        const title = document.getElementById(
          `song_config_new_title_${id}`
        ).value;

        if (!title) {
          alert("Please enter a title");
        }
        const res = fetch(`/dj/api/playlist/${timeslotId}/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ title }),
        })
          .then((res) => {
            if (res.ok) {
              window.location.reload();
            } else {
              throw new Error("Error saving song");
            }
          })
          .catch((err) => {
            console.error("Error saving song", err);
            alert("Error saving song");
          });
      }

      function playedSong(id) {
        const timeslotId = getCurrentTimeslotId();

        if (!timeslotId) {
          return;
        }

        const res = fetch(`/dj/api/playlist/${timeslotId}/${id}/mark_played`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((res) => {
            if (res.ok) {
              window.location.reload();
            } else {
              throw new Error("Error saving song");
            }
          })
          .catch((err) => {
            console.error("Error saving song", err);
            alert("Error saving song");
          });
      }

      function uncheckSongs() {
        const selectedSongs = document.querySelectorAll(
          'input[type="checkbox"]:checked'
        );

        selectedSongs.forEach((song) => {
          song.checked = false;
        });
      }

      function cancelAddSongs() {
        const dialog = document.querySelector("dialog#add_playlist");
        uncheckSongs();
        dialog.close();
      }

      function confirmAddSongs() {
        const selectedSongs = document.querySelectorAll(
          'input[type="checkbox"]:checked'
        );

        const selectedSongIdsRaw = Array.from(selectedSongs).map(
          (song) => song.id
        );

        if (selectedSongIdsRaw.some((id) => !id.startsWith("song_"))) {
          alert(
            "There was an error selecting the current song. Please refresh and try again (ID was malformed)"
          );
          return;
        }

        const selectedSongIds = selectedSongIdsRaw.map((id) => id.substring(5));

        const timeslotId = getCurrentTimeslotId();

        if (!timeslotId) {
          return;
        }

        const res = fetch(`/dj/api/playlist/${timeslotId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ songs: selectedSongIds }),
        })
          .then((res) => {
            if (res.ok) {
              uncheckSongs();
              window.location.reload();
            } else {
              throw new Error("Error adding songs to playlist");
            }
          })
          .catch((err) => {
            console.error("Error adding songs to playlist", err);
            alert("Error adding songs to playlist");
          });
      }

      function copyPlaylist(playlistId) {
        const timeslotId = getCurrentTimeslotId();

        if (!timeslotId) {
          return;
        }

        const res = fetch(`/dj/api/playlist/${timeslotId}/copy/${playlistId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        })
          .then((res) => {
            if (res.ok) {
              uncheckSongs();
              window.location.reload();
            } else {
              throw new Error("Error adding songs to playlist");
            }
          })
          .catch((err) => {
            console.error("Error adding songs to playlist", err);
            alert("Error adding songs to playlist");
          });
      }

      function onExit() {
        window.location.href = "/dj/session/exit";
      }
    </script>
  </head>

  <body>
    <%- include("./partials/header"); %>

    <main>
      <div
        style="
          max-width: 1920px;
          width: 100%;
          height: 100%;
          background-color: #494947;
        "
      >
        <div style="height: 100%; width: 100%; padding: 10px">
          <div
            style="
              display: flex;
              height: 100%;
              width: 98%;
              justify-content: space-between;
            "
          >
            <div class="main_card">
              <h2 style="text-align: center">Time Slots</h2>
              <hr style="width: 90%" />
              <ul
                id="timeslot_list"
                style="list-style-type: none; font-size: large"
              >
                <% timeslots.forEach((timeslot) => { %>
                <li>
                  <input type="radio" name="timeslot" id="timeslot_<%=
                  timeslot.id %>" <%= timeslot.selected ? 'checked' : '' %>
                  onclick="window.location.href = '<%= `/dj/${timeslot.id}` %>'"
                  />
                  <label><%= timeslot.label %></label>
                </li>
                <% }); %>
              </ul>
            </div>
            <div class="main_card">
              <div
                style="
                  display: flex;
                  flex-direction: row;
                  width: 100%;
                  align-items: center;
                  justify-content: center;
                "
              >
                <h2>Current Playlist</h2>
                <button
                  id="add_playlist"
                  style="margin-left: 10px; font-size: 20px"
                  onclick="addPlaylist()"
                >
                  +
                </button>
                <dialog id="add_playlist">
                  <form method="dialog">
                    <h2 style="text-decoration: underline">Songs</h2>
                    <ul id="add_record_song_list" style="font-size: large">
                      <% allSongs.forEach((song) => { %>
                      <li>
                        <input
                          type="checkbox"
                          id="<%= `song_${song.id}` %>"
                          name="<%= `song_${song.id}` %>"
                        />
                        <label for="<%= `song_${song.id}` %>"
                          ><%= song.title %></label
                        >
                      </li>
                      <% }); %>
                    </ul>
                    <% if (previousPlaylists.length > 0 &&
                    previousPlaylists.every((playlist) => playlist.songs.length
                    > 0)) { %>
                    <h2 style="text-decoration: underline">
                      Previous Playlists
                    </h2>
                    <div
                      id="add_record_playlist_list"
                      style="
                        display: flex;
                        flex-direction: row;
                        justify-content: space-between;
                        align-items: center;
                        width: 100%;
                        padding: 1px;
                      "
                    >
                      <% previousPlaylists.forEach((playlist) => { %> <% if
                      (playlist.songs.length === 0) { return; } %>
                      <div
                        style="
                          display: flex;
                          flex-direction: column;
                          align-items: center;
                          justify-content: center;
                        "
                      >
                        <h3 style="padding: 0px; font-size: small">
                          <%= playlist.name %>
                        </h3>
                        <p style="font-size: xx-small">12/31/69</p>
                        <ul>
                          <% playlist.songs.forEach((song) => { %>
                          <li><%= song.title %></li>
                          <% }); %>
                        </ul>
                        <button onclick="copyPlaylist('<%= playlist.id %>')">
                          Add Playlist Songs
                        </button>
                      </div>
                      <% }); %>
                    </div>
                    <% } %>
                    <menu
                      style="width: 80%; display: flex; justify-content: end"
                    >
                      <button
                        id="add_song_cancel_button"
                        value="cancel"
                        onclick="cancelAddSongs()"
                      >
                        Cancel
                      </button>
                      <button
                        id="add_song_ok_button"
                        style="margin-left: 2px"
                        value="ok"
                        onclick="confirmAddSongs()"
                      >
                        OK
                      </button>
                    </menu>
                  </form>
                </dialog>
              </div>
              <h3 style="padding: 0px auto; text-align: center">
                <%= playlist.name %>
              </h3>
              <hr style="width: 95%" />
              <table
                id="playlist_table"
                style="width: 100%; text-align: center"
                class="draggable_table"
              >
                <tr>
                  <th></th>
                  <th id="number_column">#</th>
                  <th>Name</th>
                  <th>Producer Selected</th>
                  <th>Played</th>
                  <th></th>
                </tr>
                <% playlistSongs.forEach((song, index) => { %>
                <tr id="<%= `table_row_${song.id}` %>">
                  <td>
                    <svg
                      width="20px"
                      height="20px"
                      viewBox="0 0 24 24"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                      style="cursor: pointer; user-select: none"
                    >
                      <path
                        d="M4 18L20 18"
                        stroke="#000000"
                        stroke-width="2"
                        stroke-linecap="round"
                      ></path>
                      <path
                        d="M4 12L20 12"
                        stroke="#000000"
                        stroke-width="2"
                        stroke-linecap="round"
                      ></path>
                      <path
                        d="M4 6L20 6"
                        stroke="#000000"
                        stroke-width="2"
                        stroke-linecap="round"
                      ></path>
                    </svg>
                  </td>
                  <td><%= index + 1 %></td>
                  <td><%= song.title %></td>
                  <td><%= song.producer_created ? 'Yes' : 'No' %></td>
                  <td><%= song.dj_played ? 'Yes' : 'No' %></td>
                  <td>
                    <button
                      onclick="document.getElementById('<%= `song_config_${song.playlistSongId}` %>').showModal()"
                    >
                      ⚙
                    </button>
                    <dialog id="<%= `song_config_${song.playlistSongId}` %>">
                      <label>Title</label>
                      <div style="display: flex; flex-direction: column">
                        <input
                          id="<%= `song_config_new_title_${song.playlistSongId}` %>"
                          value="<%= song.title %>"
                          type="text"
                        /><menu>
                          <button
                            onclick="playedSong('<%= song.playlistSongId %>')"
                            type="button"
                          >
                            Mark Played
                          </button>
                          <button
                            onclick="deleteSong('<%= song.playlistSongId %>')"
                            type="button"
                          >
                            Delete</button
                          ><button
                            onclick="saveSong('<%= song.id %>')"
                            type="button"
                            style="margin-left: 2px"
                          >
                            Save</button
                          ><button
                            onclick="document.getElementById('<%= `song_config_${song.playlistSongId}` %>').close(); document.getElementById('<%= `song_config_new_title_${song.playlistSongId}` %>').value = '<%= song.title %>'"
                            type="button"
                            style="margin-left: 2px"
                          >
                            Cancel
                          </button></menu
                        >
                      </div>
                    </dialog>
                  </td>
                </tr>
                <% }); %>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>

    <%- include("./partials/footer"); %>

    <script src="/static/DJ/js/drag.js"></script>
  </body>
</html>
